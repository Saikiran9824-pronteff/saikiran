<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-ci-cd" default="pipeline" basedir=".">
    <description>
        Ant script for IBM API Connect CI/CD automation with auto logout.
    </description>

    <!-- Load environment properties dynamically -->
    <property file="environments/${env}.properties"/>

    <!-- Login -->
    <target name="login">
        <echo message="Logging into API Connect at ${apic.server}..."/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="login"/>
            <arg value="--server=${apic.server}"/>
            <arg value="--username=${apic.username}"/>
            <arg value="--password=${apic.password}"/>
            <arg value="--realm=${apic.realm}"/>
            <arg value="--accept-license"/>
        </exec>
    </target>

    <!-- Validate API + Product -->
    <target name="validate" depends="login">
        <echo message="Validating API file: ${api.file}"/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="validate"/>
            <arg value="${api.file}"/>
            <arg value="--accept-license"/>
        </exec>

        <echo message="Validating Product file: ${product.file}"/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="validate"/>
            <arg value="${product.file}"/>
            <arg value="--accept-license"/>
        </exec>
    </target>

    <!-- Publish -->
    <target name="publish" depends="validate">
        <echo message="Publishing API product: ${product.file} to org=${apic.org}, catalog=${apic.catalog}"/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="publish"/>
            <arg value="${product.file}"/>
            <arg value="--server=${apic.server}"/>
            <arg value="--org=${apic.org}"/>
            <arg value="--catalog=${apic.catalog}"/>
            <arg value="--accept-license"/>
        </exec>
    </target>

    <!-- Deploy (Replace Product in Catalog) -->
    <target name="deploy" depends="publish">
        <echo message="Deploying (replacing) API product: ${product.file} into org=${apic.org}, catalog=${apic.catalog}"/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="products:replace"/>
            <arg value="--server=${apic.server}"/>
            <arg value="--org=${apic.org}"/>
            <arg value="--catalog=${apic.catalog}"/>
            <arg value="${product.file}"/>
            <arg value="--accept-license"/>
        </exec>
    </target>

    <!-- Logout -->
    <target name="logout" alwaysRun="true">
        <echo message="Logging out of API Connect..."/>
        <exec executable="/usr/local/bin/apic" failonerror="false">
            <arg value="logout"/>
            <arg value="--server=${apic.server}"/>
            <arg value="--accept-license"/>
        </exec>
    </target>

    <!-- Pipeline wrapper (ensures logout always runs) -->
    <target name="pipeline">
        <antcall target="deploy"/>
        <antcall target="logout"/>
    </target>
</project>
