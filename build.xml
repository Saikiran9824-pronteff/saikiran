<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-ci-cd" default="deploy" basedir=".">

    <!-- Load environment properties dynamically -->
    <property file="environments/${env}.properties"/>

    <!-- Accept License -->
    <target name="accept-license">
        <echo message="Accepting IBM API Connect license..."/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="accept-license"/>
            <arg value="--accept"/>
        </exec>
    </target>

    <!-- Login -->
    <target name="login" depends="accept-license">
        <echo message="Logging into API Connect..."/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="login"/>
            <arg value="--server=${apic.server}"/>
            <arg value="--username=${apic.username}"/>
            <arg value="--password=${apic.password}"/>
            <arg value="--realm=${apic.realm}"/>
            <arg value="--accept-license"/>
        </exec>
    </target>

    <!-- Validate API -->
    <target name="validate-api" depends="login">
        <echo message="Validating API ${api.file} ..."/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="validate"/>
            <arg value="${api.file}"/>
        </exec>
    </target>

    <!-- Validate Product -->
    <target name="validate-product" depends="login">
        <echo message="Validating Product ${product.file} ..."/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="validate"/>
            <arg value="${product.file}"/>
        </exec>
    </target>

    <!-- Publish Product -->
    <target name="publish" depends="validate-api,validate-product">
        <echo message="Publishing Product to Catalog..."/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="publish"/>
            <arg value="${product.file}"/>
            <arg value="--server=${apic.server}"/>
            <arg value="--org=${apic.org}"/>
            <arg value="--catalog=${apic.catalog}"/>
        </exec>
    </target>

    <!-- Deploy Product -->
    <target name="deploy" depends="publish">
        <echo message="Deploying Product ${product.name} to Catalog..."/>
        <exec executable="/usr/local/bin/apic" failonerror="true">
            <arg value="deploy"/>
            <arg value="${product.name}"/>
            <arg value="--server=${apic.server}"/>
            <arg value="--org=${apic.org}"/>
            <arg value="--catalog=${apic.catalog}"/>
        </exec>
    </target>

</project>
